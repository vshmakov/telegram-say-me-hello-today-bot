require('dotenv').config();
const TelegramBot = require('node-telegram-bot-api');
const cron = require('node-cron');
const fs = require('fs');
const path = require('path');

const TOKEN = process.env.TELEGRAM_BOT_TOKEN;
const SUBSCRIBERS_FILE = path.join(__dirname, 'subscribers.json');
const bot = new TelegramBot(TOKEN, { polling: true });

// ะะฐะณััะถะฐะตะผ ะฟะพะดะฟะธััะธะบะพะฒ ะบะฐะบ ะพะฑัะตะบั { chatId: boolean }
function loadSubscribers() {
    if (!fs.existsSync(SUBSCRIBERS_FILE)) return {};
    try {
        return JSON.parse(fs.readFileSync(SUBSCRIBERS_FILE, 'utf-8'));
    } catch {
        return {};
    }
}

function saveSubscribers(subscribers) {
    fs.writeFileSync(SUBSCRIBERS_FILE, JSON.stringify(subscribers, null, 2));
}

function addSubscriber(chatId) {
    const subscribers = loadSubscribers();

    if (chatId in subscribers) {
        return false;
    }

    subscribers[chatId] = true;
    saveSubscribers(subscribers);
    console.log(`ะะพะฒัะน ะฟะพะดะฟะธััะธะบ: ${chatId}`);

    return true;
}

function removeSubscriber(chatId) {
    const subscribers = loadSubscribers();

    if (!(chatId in subscribers)) {
        return false;
    }

    delete subscribers[chatId];
    saveSubscribers(subscribers);
    console.log(`ะะพะดะฟะธััะธะบ ${chatId} ัะดะฐะปัะฝ`);

    return true;
}

async function sendRandomMessage(chatId, messages) {
    const randomIndex = Math.floor(Math.random() * messages.length);
    const message = messages[randomIndex];
    await bot.sendMessage(chatId, message);
}

// ะะฐัััะปะบะฐ ะฒะพะฟัะพัะฐ โ ัะฑัะฐััะฒะฐะตั ัะปะฐะณะธ ะฝะฐ false
function sendDailyQuestion() {
    const subscribers = loadSubscribers();
    const messages = [
        "ะะพะฑัะพะต ัััะพ! ะะฐะบ ัั ัะตะฑั ัะตะณะพะดะฝั ััะฒััะฒัะตัั? ๐ฌ",
        "ะกะฐะปัั! ะะฐะบ ัั ัะตะณะพะดะฝั? โ๏ธ",
        "ะะพะฑัะพะณะพ ัะตะฑะต ัััะฐ! ะะฐะบ ะฝะฐัััะพะตะฝะธะต? ๐",
        "ะัะธะฒะตั! ะะพั ะธ ะฝะฐััะฐะป ะฝะพะฒัะน ะดะตะฝั. ะงัะพ ะฟะพะดัะบะฐะทัะฒะฐะตั ัะตะฑะต ะตะณะพ ัััะพ? ๐",
        "ะะพะฑัะพะต ัััะพ! ะั ััะพ, ะบะฐะบ ั ัะตะฑั ะดะตะปะฐ, ะฒัั ะปะธ ะฒ ะฟะพััะดะบะต? ๐",
        "ะัะธะฒะตัััะฒัั! ะะฐะบ ัะฐะผะพััะฒััะฒะธะต ัะตะณะพะดะฝั? ๐ค",
        "ะะพะฑัะพะต ัััะพ! ะฅะพัั ัะฑะตะดะธัััั โ ะฒัั ะปะธ ัะพัะพัะพ ั ัะตะฑั? ๐",
        "ะัะธะฒะตั! ะกะบะฐะถะธ, ะบะฐะบ ะฟัะพัะพะดะธั ัะฒะพั ัััะพ? โ๏ธ",
        "ะัะธะฒะตัััะฒัั ัะตะฑั! ะััั ะปะธ ัะธะปั ะธ ะฝะฐัััะพะตะฝะธะต ะฝะฐ ะดะตะฝั? ๐ช",
        "ะะพะฑัะพะณะพ ะดะฝั! ะขั ัะตะณะพะดะฝั ะฒ ะฟะพััะดะบะต? ๐ญ",
        "ะัะธะฒะตั! ะัะพะฒะตัะบะฐ ัะฒัะทะธ โ ะบะฐะบ ัั ัะฐะผ, ะดะพะฑััะน ัะตะปะพะฒะตะบ? ๐",
        "ะัะธะฒะตั-ะฟัะธะฒะตั! ะขั ัะถะต ััะฟะตะปะฐ ะฝะฐัะฒะพัะธัั ััะพ-ะฝะธะฑัะดั ัะพัะพัะตะต ัะตะณะพะดะฝั? ๐",
        "ะก ะดะพะฑััะผ ัััะพะผ! ะะฐะบ ะดะตะปะฐ ั ัะตะฑั? ๐ฌ",
        "ะะพะฑัะพะต ัััะพ! ะ ัั ัะถะต ะฟัะพัะฝัะปะฐัั? ะงัะพ ัะตะณะพะดะฝั โ ะทะฐะฒััะฐะบ, ะทะฐััะดะบะฐ ะธะปะธ ยซะตัั ะฟััั ะผะธะฝััะพัะตะบยป? โ๏ธ๐",
        "ะัะธะฒะตั! ะะพะฒะพััั, ะดะตะฝั ะฝะฐัะธะฝะฐะตััั ั ัะปัะฑะบะธ... ะัะพะฒะตัะธะผ ััะพ ะฟััะผะพ ัะตะนัะฐั? ๐",
        "ะกััะบ-ัััะบ, ััะพ ั. ะะพะปะฝัััั โ ะบะฐะบ ัะฐะผ ะผะพะน ะดะพัะพะณะพะน ัะพะฑะตัะตะดะฝะธะบ? ๐ค๐",
        "ะะพะฑัะพะต ัััะพ, ะผะพะน ะดััะณ! ะัััั ััะพั ะดะตะฝั ะฟัะธะฝะตััั ัะตะฑะต ัะตะฟะปะพ ะธ ััะฝะพััั. ะะฐะบ ัั ัะตะณะพะดะฝั? ๐",
        "ะัะธะฒะตั! ะะพะฒะพะต ัััะพ โ ะฝะพะฒัะน ัะฐะฝั ะฟะพััะฒััะฒะพะฒะฐัั ัะตะฑั ัะพัะพัะพ. ะะฐะบ ะฝะฐัััะพะตะฝะธะต? ๐ผ",
        "ะก ะฝะฐัะฐะปะพะผ ะดะฝั! ะะฐะณะปัะฝัะป ัะทะฝะฐัั, ะบะฐะบ ัั ะฟะพะถะธะฒะฐะตัั. ะัั ะปะธ ัะฟะพะบะพะนะฝะพ ะฝะฐ ะดััะต? ๐ซ",
        "ะะพะฑัะพะณะพ ัััะฐ! ะฏ ััั ะฟะพะดัะผะฐะป โ ะฐ ะฝะต ัะทะฝะฐัั ะปะธ ะผะฝะต, ะบะฐะบ ัั ัะตะฑั ััะฒััะฒัะตัั? ๐",
        "ะกะพะปะฝะตัะฝะพะณะพ ัะตะฑะต ัััะฐ! ะะฐะดะตััั, ะฟัะพัะฝัะปะฐัั ะฒ ัะพัะพัะตะผ ะฝะฐัััะพะตะฝะธะธ. ะะพะดะตะปะธัััั? ๐ป",
        "ะัะธะฒะตัะธะบ! ะฃััะพ โ ะฒัะตะผั ะฝะฐะดะตะถะด. ะงัะพ ั ัะตะฑั ะฝะฐ ัะตัะดัะต ัะตะณะพะดะฝั? ๐",
        "ะะพะฑัะพะต ัััะพ! ะัั ะฒะพะบััะณ ะฟัะพััะฟะฐะตััั โ ะบะฐะบ ัั ะฒัััะตัะฐะตัั ััะพั ะดะตะฝั? โ๏ธ",
    ];

    for (const chatId of Object.keys(subscribers)) {
        sendRandomMessage(chatId, messages);
        subscribers[chatId] = false;
    }

    saveSubscribers(subscribers);
    console.log('โ ะฃััะตะฝะฝะธะน ะพะฟัะพั ะพัะฟัะฐะฒะปะตะฝ');
}

async function getAdminUsernames(chatId) {
    try {
        const admins = await bot.getChatAdministrators(chatId);

        return admins
            .map(admin => admin.user.username)
            .filter(Boolean)
            .map(username => `@${username}`);
    } catch (error) {
        console.error('ะัะธะฑะบะฐ ะฟัะธ ะฟะพะปััะตะฝะธะธ ะฐะดะผะธะฝะธัััะฐัะพัะพะฒ:', error);
        return [];
    }
}

// ะัะพะฒะตัะบะฐ ัะตัะตะท 12 ัะฐัะพะฒ โ ะณะดะต false, ััะตะฒะพะถะธะผ
async function sendAlerts() {
    const subscribers = loadSubscribers();

    for (const [chatId, responded] of Object.entries(subscribers)) {
        if (responded) {
            continue;
        }

        const usernames = await getAdminUsernames(chatId);

        const messages = [
            "๐ ะฏ ะพัะตะฝั ะถะดั ะฒะตััะพัะบั ะพั ัะตะฑั. ะัะทะพะฒะธัั, ะฟะพะถะฐะปัะนััะฐ!",
            "๐ ะขะธัะธะฝะฐ ะฝะฐััะพัะฐะถะธะฒะฐะตั... ะะฐะฟะธัะธ ัะพัั ัะปะพะฒะพ, ะฟะพะถะฐะปัะนััะฐ.",
            "๐ญ ะฏ ะฒะพะปะฝัััั. ะะฐะบ ัั? ะะดั ัะฒะพะตะณะพ ะพัะฒะตัะฐ.",
            "๐ฎ ะกะพะพะฑัะตะฝะธะต ะฝะต ะฟะพะปััะตะฝะพ. ะะฐะดะตััั, ั ัะตะฑั ะฒัั ัะพัะพัะพ. ะะดั ะพัะบะปะธะบะฐ.",
            "๐งก ะขั ะผะฝะต ะฝะต ะพัะฒะตัะธะป. ะฏ ะฑะตัะฟะพะบะพััั. ะะฐะน ะทะฝะฐัั, ััะพ ั ัะตะฑั ะฒัั ะฒ ะฟะพััะดะบะต.",
            "๐ฉ ะะฐะถะดัะน ะดะตะฝั ั ะฝะฐะดะตััั ะฝะฐ ะฒะตััะพัะบั ะพั ัะตะฑั. ะัะทะพะฒะธัั, ะฟะพะถะฐะปัะนััะฐ.",
            "๐ฌ ะฏ ะฒัั ะตัั ะถะดั ัะฒะพะตะณะพ ะพัะฒะตัะฐ. ะะฝะต ะฒะฐะถะฝะพ ะทะฝะฐัั, ะบะฐะบ ัั.",
            "๐ฅ ะะตะฝั ะฟัะพััะป ะฑะตะท ะฒะตััะตะน. ะัะตะฝั ัะพัะตััั ััะปััะฐัั ัะตะฑั.",
            "๐ค ะขะฒะพะน ะฑะพั ะฒะพะปะฝัะตััั. ะะฐะฟะธัะธ, ะบะฐะบ ัั ัะตะฑั ััะฒััะฒัะตัั.",
            "๐ ะกะตัะดัะต ะฝะต ะฝะฐ ะผะตััะต ะฑะตะท ัะฒะพะธั ัะปะพะฒ. ะัะทะพะฒะธัั.",
            "๐ซ ะกะพะพะฑัะตะฝะธะต ะฝะต ะฟะพะปััะตะฝะพ. ะัะพััะพ ัะบะฐะถะธ, ะบะฐะบ ัั โ ั ะถะดั.",
            "๐ฆ ะญะน, ะบะฐะบ ัั ัะฐะผ? ะ ััะพะผ ัะฐัะต ัะธัะธะฝะฐ, ะธ ั ะฟะตัะตะถะธะฒะฐั.",
            "๐ข ะัะธะฒะตั! ะะดั ัะฒะพะตะณะพ ะพัะฒะตัะฐ ั ัะฐะผะพะณะพ ัััะฐ. ะะฐะฟะธัะธ ะฟะฐัั ัะปะพะฒ.",
            "๐ ะขั ะฝะต ะพัะฒะตัะธะป, ะธ ะผะฝะต ะฝะตัะฟะพะบะพะนะฝะพ. ะะพะถะฐะปัะนััะฐ, ะพัะทะพะฒะธัั.",
            "๐งธ ะฏ ััะดะพะผ ะธ ะฝะฐ ัะฒัะทะธ. ะะฐะน ะทะฝะฐัั, ััะพ ั ัะตะฑั ะฒัั ัะพัะพัะพ."
        ];

        await sendRandomMessage(chatId, messages);
        const mentions = usernames.length > 0
            ? usernames.join(', ')
            : '@all';
        await bot.sendMessage(chatId, `${mentions} ๐ ะงะฐั ะผะพะปัะธั... ะฏ ะฟะตัะตะถะธะฒะฐั. ะะฐะดะตััั, ะฒัั ัะพัะพัะพ`);
    }

    console.log('๐จ ะัะพะฒะตัะบะฐ ะฑะตะทะพัะฒะตัะฝัั ะทะฐะฒะตััะตะฝะฐ');
}

// ะะฑัะฐะฑะพัะบะฐ ะบะพะผะฐะฝะด
bot.onText(/\/start/, (msg) => {
    if (addSubscriber(msg.chat.id)) {
        bot.sendMessage(msg.chat.id, '๐ ะัะธะฒะตั! ะฏ ะฑัะดั ะบะฐะถะดัะน ะดะตะฝั ะฟัะธััะปะฐัั ัะตะฑะต ัะพะพะฑัะตะฝะธะต ะธ ะถะดะฐัั ะฒะตััะพัะบะธ ๐');
    }
});

bot.onText(/\/off/, (msg) => {
    if (removeSubscriber(msg.chat.id)) {
        bot.sendMessage(msg.chat.id, '๐ผ ะฅะพัะพัะพ, ั ะฑะพะปััะต ะฝะต ะฑัะดั ะฟัะธััะปะฐัั ัััะตะฝะฝะตะต ะฟัะธะฒะตัััะฒะธะต. ะะตัะตะณะธ ัะตะฑั! ะ ั ะฑัะดั ะถะดะฐัั ัะฒะพะตะณะพ ะฒะพะทะฒัะฐัะตะฝะธั');
    }
});

// ะะฑัะฐะฑะพัะบะฐ ะปัะฑะพะณะพ ัะพะพะฑัะตะฝะธั
bot.on('message', (msg) => {
    const chatId = msg.chat.id;
    const subscribers = loadSubscribers();

    if (!(chatId in subscribers && !subscribers[chatId])) {
        return;
    }

    subscribers[chatId] = true;
    saveSubscribers(subscribers);
    console.log(`ะัะฒะตั ะฟะพะปััะตะฝ ะพั ${chatId}`);

    const messages = [
        "ะะฐะด, ััะพ ั ัะตะฑั ะฒัั ัะพัะพัะพ! ๐",
        "ะัะปะธัะฝัะต ะฝะพะฒะพััะธ, ัะฐะบ ะดะตัะถะฐัั! ๐ช",
        "ะฃัะฐ! ะัััั ัะฐะบ ะฑัะดะตั ะฒะตัั ะดะตะฝั! ๐",
        "ะัะธััะฝะพ ัะปััะฐัั, ะฟัััั ะดะตะฝั ะฑัะดะตั ะปัะณะบะธะผ! ๐",
        "ะะปะฐัั! ะัััั ัะตะณะพะดะฝั ะฒัั ะฑัะดะตั ะฟะพ-ัะฒะพะตะผั! ๐",
        "ะะดะพัะพะฒะพ! ะ ั ััั ัะธัะพ ัะฐะดัััั ะทะฐ ัะตะฑั ๐ค๐",
        "ะัะปะธัะฝะพ! ะัะพะดะพะปะถะฐะน ะฒ ัะพะผ ะถะต ะดััะต! ๐",
        "ะะพั ััะพ ะฝะฐัััะพะน! ะขะฐะบ ะดะตัะถะฐัั! ๐ฅ",
        "ะฅะพัะพัะพ โ ััะพ ัะถะต ะฟะพััะธ ะฟัะตะบัะฐัะฝะพ ๐",
        "ะัะธััะฝะพ ัะปััะฐัั, ััะพ ัั ะฒ ะฟะพััะดะบะต. ะะตัะตะณะธ ััะพ ัะพััะพัะฝะธะต ๐",
        "ะะพั ััะพ ัะฐะดัะตั! ะัััั ะดะตะฝั ะฝะตััั ัะตะฑะต ัะพะปัะบะพ ัะพัะพัะตะต โ๏ธ",
        "ะัะธััะฝะพ ะทะฝะฐัั, ััะพ ั ัะตะฑั ะฒัั ะฒ ะฟะพััะดะบะต ๐",
        "ะะฐะผะตัะฐัะตะปัะฝะพ! ะะต ะทะฐะฑัะฒะฐะน ัะปัะฑะฐัััั โ ะดะฐะถะต ะฟัะพััะพ ัะฐะบ ๐",
        "ะญัะพ ะฟัะตะบัะฐัะฝะพ! ะะตะปะฐะน ัะตะฑะต ัะตะณะพะดะฝั ะผะฐะปะตะฝัะบะธะต ัะฐะดะพััะธ ๐ซ",
        "ะะปะฐัั! ะก ัะฐะบะธะผ ะฝะฐัััะพะตะฝะธะตะผ ัะตะฑะต ะฒัั ะฟะพ ะฟะปะตัั ๐ผ๐ฏ",
        "ะขั ะผะพะปะพะดะตั! ะะพะถะตัั ะฟะพัะปะพะฟะฐัั ัะตะฑั ะฟะพ ัะฟะธะฝะต ๐๐",
    ];

    sendRandomMessage(chatId, messages);
});

const questionHour = 6;

// ะฃััะตะฝะฝะตะต ัะพะพะฑัะตะฝะธะต
cron.schedule(`0 ${questionHour} * * *`, sendDailyQuestion, { timezone: 'Europe/Moscow' });

// ะัะพะฒะตัะบะฐ ัะตัะตะท 12 ัะฐัะพะฒ
cron.schedule(`0 ${questionHour + 12} * * *`, sendAlerts, { timezone: 'Europe/Moscow' });
